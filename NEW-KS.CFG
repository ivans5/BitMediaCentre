#NOTE: Kickstart file Originated from:
# Generated by Anaconda 33.25.4
# Generated by pykickstart v3.29
#version=F33


# OSTree setup
ostreesetup --osname="fedora-iot" --remote="fedora-iot" --url="file:///ostree/repo" --ref="fedora/stable/x86_64/iot" --nogpg
# XXX - DONT Use graphical install
#graphical
text

#
#  ---  BEGIN PERCENT POST SECTION -----
#
#NOTE: no percent packages section on fedora-iot,see: https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_atomic_host/7/html/installation_and_configuration_guide/types_of_installation#kickstart_installation
#
#
#TODO: log to console somehow; also time profiling
#
#
%post --erroronfail --nochroot --log=/tmp/ks-post.log

# Update files on /mnt/sysroot/etc BEFORE finalizing the staged deployment
# ,Or else it will revert the changes!

# Update Sudoers:
cat > /mnt/sysroot/etc/sudoers <<END
Defaults   !visiblepw
Defaults    env_reset
Defaults    env_keep =  "COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR LS_COLORS"
Defaults    env_keep += "MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE"
Defaults    env_keep += "LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES"
Defaults    env_keep += "LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE"
Defaults    env_keep += "LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY"
Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin
root	ALL=(ALL) 	ALL
%wheel	ALL=(ALL)	NOPASSWD: ALL
END
chmod 0440 /mnt/sysroot/etc/sudoers
######

# Keep sound cards woke: #TODO: get this working:
#/bin/cp /mnt/sysroot/etc/pulse/default.pa /mnt/sysroot/etc/pulse/default.pa.orig -v
#sed -i 's/^load-module module-suspend-on-idle/#&/' /mnt/sysroot/etc/pulse/default.pa
########

# Uncomment the following to stop low-level messages on console:
cat > /mnt/sysroot/etc/sysctl.d/squelch.conf <<END
kernel.printk = 3 4 1 3
END
#######

# Dont kill user processes :
echo KillUserProcesses=no >> /mnt/sysroot/etc/systemd/logind.conf

######################################################################
# Now Update Packages: 
#https://gist.github.com/jlebon/dbfd27350abac814171c7b49923fdc4e  :
#TODO: install a layer from a custom ostree repo...
#Note: See: https://fedoraproject.org/wiki/Changes/DbusBrokerAsTheDefaultDbusImplementation
PACKAGES="vim wget openssl tree aria2 mc sox pulseaudio ncurses "\
"alsa-utils libcgroup-tools net-tools pulseaudio-utils "\
"adwaita-gtk2-theme adwaita-icon-theme "\
"sway "\
"virtualbox-guest-additions "\
"gnome-terminal dbus-daemon epiphany grim "\
"python3-pip python3-evdev python3-netifaces "\
"https://github.com/ivans5/BitMediaCentre/raw/master/bitmediacentre-base-rpm/rpmbuild/RPMS/x86_64/bitmediacentre-base-1.0-el6.x86_64.rpm "\
"https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(/mnt/sysroot/usr/bin/rpm -E %fedora).noarch.rpm https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(/mnt/sysroot/usr/bin/rpm -E %fedora).noarch.rpm "\
"mpv "
echo PACKAGES are: $PACKAGES

#Need to Add RPMFusion to /etc/yum.repos.d/ manually also:
chroot /mnt/sysroot /bin/sh -c 'cd / && curl -L https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm > /var/rpmfusion-free.rpm'
chroot /mnt/sysroot /bin/sh -c "cd / && rpm2cpio /var/rpmfusion-free.rpm | cpio -idmv"
#And for rpmfusion-nonfree:
chroot /mnt/sysroot /bin/sh -c 'cd / && curl -L https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm > /var/rpmfusion-nonfree.rpm'
chroot /mnt/sysroot /bin/sh -c "cd / && rpm2cpio /var/rpmfusion-nonfree.rpm | cpio -idmv"

#Change default systemd target to graphical:
chroot /mnt/sysroot /bin/sh -c "systemctl set-default graphical.target"

mkdir /mnt/bwrap_workaround
mount --rbind /mnt/sysroot /mnt/bwrap_workaround  
mount --make-private /mnt/bwrap_workaround
mount --rbind /mnt/bwrap_workaround /mnt/bwrap_workaround

chroot /mnt/bwrap_workaround /usr/libexec/rpm-ostreed --debug &  
touch /mnt/sysroot/run/ostree-booted

#TODO:remove debugging:
echo HERE ARE YOUR ORIG KARGS:
chroot /mnt/sysroot /bin/sh -c "rpm-ostree kargs --os=fedora-iot"

chroot /mnt/sysroot /bin/sh -c "rpm-ostree install $PACKAGES --os=fedora-iot && ostree admin finalize-staged" # && ostree admin deploy ostree/???"

chroot /mnt/sysroot /bin/sh -c "rpm-ostree status"
echo HERE ARE YOUR NEW KARGS, TODO: automate the grub thing?
chroot /mnt/sysroot /bin/sh -c "rpm-ostree kargs --os=fedora-iot"

#Install optional k3s-agent: TODO: move to rpm?
mkdir /mnt/sysroot/var/start
wget -O /mnt/sysroot/var/start/k3s https://github.com/rancher/k3s/releases/download/v1.17.5%2Bk3s1/k3s
chmod +x /mnt/sysroot/var/start/k3s

%end

# Keyboard layouts
keyboard --xlayouts='us'
# System language
#lang en_CA.UTF-8
#lang en_US.UTF-8
lang C.UTF-8

#TODO?
#firewall --disabled
#services --enabled=NetworkManager,sshd

# Firewall configuration
firewall --use-system-defaults
# Network information
network  --hostname=BitMediaCentre
#Disable SELinux (NOTE: Disabling SELinux breaks the instal for some reason):
#selinux --disabled


# Run the Setup Agent on first boot
#XXX
#firstboot --enable

#MINE:
ignoredisk --only-use=sdb
bootloader --location=mbr 
zerombr
clearpart --all --initlabel
part /boot --size=512 --asprimary --ondrive=sdb --fstype=xfs
#part swap --size=10240 --ondrive=sda 
part / --size=8192 --grow --asprimary --ondrive=sdb --fstype=xfs 

# System timezone
timezone America/Vancouver --utc

#non-root user:
user --name=pcuser --password=pcuser --plaintext --groups=wheel
rootpw --lock

# Root password
#rootpw --iscrypted $6$tBCS7ZkEfY/I2Rr1$6NDunHAszqFFwcRRXwx75SI7PqrqkFpXw45PWo/ddrsbNaYZJrTvw8HZb10ExisamA48rn2Mv38qcB6bCNjpk/

%addon com_redhat_kdump --disable --reserve-mb='128'

%end

%anaconda
pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty
pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok
pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty
%end
