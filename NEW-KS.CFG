#NOTE: Kickstart file Originated from:
# Generated by Anaconda 33.25.4
# Generated by pykickstart v3.29
#version=F33


# OSTree setup
ostreesetup --osname="fedora-iot" --remote="fedora-iot" --url="file:///ostree/repo" --ref="fedora/stable/x86_64/iot" --nogpg
#graphical
text

###XXX - HACK TO USE ANACONDA OVER WIFI:
#%pre
#nmcli r wifi on
#nmcli d wifi connect SSID_NAME password WIFI_PASSWORD
#ifconfig enp0s25 1.2.3.4 netmask 255.255.255.255 up
#sleep 5
#%end


#
#  ---  BEGIN PERCENT POST SECTION -----
#
#NOTE: no percent packages section on fedora-iot,see: https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_atomic_host/7/html/installation_and_configuration_guide/types_of_installation#kickstart_installation
#
#
#TODO: log to console somehow; also time profiling
#
#
%post --erroronfail --nochroot --log=/tmp/ks-post.log

# Update files on /mnt/sysroot/etc BEFORE finalizing the staged deployment
# ,Or else it will revert the changes!

# Update Sudoers:
cat > /mnt/sysroot/etc/sudoers <<END
Defaults   !visiblepw
Defaults    env_reset
Defaults    env_keep =  "COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR LS_COLORS"
Defaults    env_keep += "MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE"
Defaults    env_keep += "LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES"
Defaults    env_keep += "LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE"
Defaults    env_keep += "LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY"
Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin
root	ALL=(ALL) 	ALL
%wheel	ALL=(ALL)	NOPASSWD: ALL
END
chmod 0440 /mnt/sysroot/etc/sudoers
######

# Keep sound cards woke: #TODO: get this working:
#Note: There is a low power blacklist that i saw, it may already be there...
#/bin/cp /mnt/sysroot/etc/pulse/default.pa /mnt/sysroot/etc/pulse/default.pa.orig -v
#sed -i 's/^load-module module-suspend-on-idle/#&/' /mnt/sysroot/etc/pulse/default.pa
########

# Uncomment the following to stop low-level messages on console:
cat > /mnt/sysroot/etc/sysctl.d/squelch.conf <<END
kernel.printk = 3 4 1 3
END
#######

# Dont kill user processes :
echo KillUserProcesses=no >> /mnt/sysroot/etc/systemd/logind.conf

######################################################################
# Now Update Packages: 
#https://gist.github.com/jlebon/dbfd27350abac814171c7b49923fdc4e  :
#TODO: install a layer from a custom ostree repo...
#Note: there will be an extra dbus.... See: https://fedoraproject.org/wiki/Changes/DbusBrokerAsTheDefaultDbusImplementation
#Note: linux-firmware and kernel-modules already present...
#TODO: lsof tcpdump strace valgrind etc.
#TODO: rpmfusion-free-release-tainted libdvdcss etc.
PACKAGES="vim wget openssl tree aria2 mc sox pulseaudio ncurses "\
"alsa-utils libcgroup-tools net-tools pulseaudio-utils "\
"adwaita-gtk2-theme adwaita-icon-theme "\
"sway "\
"mesa-dri-drivers dejavu-sans-mono-fonts dejavu-sans-fonts gnome-backgrounds-extras "\
"virtualbox-guest-additions "\
"gnome-terminal dbus-daemon epiphany grim "\
"python3-pip python3-evdev python3-netifaces "\
"https://github.com/ivans5/BitMediaCentre/raw/master/bitmediacentre-base-rpm/rpmbuild/RPMS/x86_64/bitmediacentre-base-1.0-el6.x86_64.rpm "\
"https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(/mnt/sysroot/usr/bin/rpm -E %fedora).noarch.rpm https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(/mnt/sysroot/usr/bin/rpm -E %fedora).noarch.rpm "\
"https://github.com/k3s-io/k3s-selinux/releases/download/v0.2.stable.1/k3s-selinux-0.2-1.el7_8.noarch.rpm "\
"mpv transmission-daemon transmission-cli transmission "
echo PACKAGES are: $PACKAGES

#Need to Add RPMFusion to /etc/yum.repos.d/ manually also:
chroot /mnt/sysroot /bin/sh -c 'cd / && curl -L https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm > /var/rpmfusion-free.rpm'
chroot /mnt/sysroot /bin/sh -c "cd / && rpm2cpio /var/rpmfusion-free.rpm | cpio -idmv"
#And for rpmfusion-nonfree:
chroot /mnt/sysroot /bin/sh -c 'cd / && curl -L https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm > /var/rpmfusion-nonfree.rpm'
chroot /mnt/sysroot /bin/sh -c "cd / && rpm2cpio /var/rpmfusion-nonfree.rpm | cpio -idmv"

#Change default systemd target to graphical:
chroot /mnt/sysroot /bin/sh -c "systemctl set-default graphical.target"

mkdir /mnt/bwrap_workaround
mount --rbind /mnt/sysroot /mnt/bwrap_workaround  
mount --make-private /mnt/bwrap_workaround
mount --rbind /mnt/bwrap_workaround /mnt/bwrap_workaround

chroot /mnt/bwrap_workaround /usr/libexec/rpm-ostreed --debug &  
touch /mnt/sysroot/run/ostree-booted

#TODO:remove debugging:
echo HERE ARE YOUR ORIG KARGS:
chroot /mnt/sysroot /bin/sh -c "rpm-ostree kargs --os=fedora-iot"

#XXX
cat > /mnt/sysroot/etc/sysconfig/network-scripts/ifcfg-__SSID__NAME__ <<END
ESSID=__SSID__NAME__
MODE=Managed
KEY_MGMT=WPA-PSK
SECURITYMODE=open
MAC_ADDRESS_RANDOMIZATION=default
TYPE=Wireless
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=dhcp
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=__SSID__NAME__
ONBOOT=yes
END
cat > /mnt/sysroot/etc/sysconfig/network-scripts/keys-__SSID__NAME__ <<END
WPA_PSK="__WIFI__PASSWORD"
END
chmod 600 /mnt/sysroot/etc/sysconfig/network-scripts/keys-__SSID__NAME__

#XXX
chroot /mnt/sysroot /bin/sh -c "rpm-ostree kargs --append=video=HDMI-A-1:d --append=video=DP-1:1920x1080@60+32 --append=systemd.unified_cgroup_hierarchy=0 --append=mitigations=off --delete nomodeset"

chroot /mnt/sysroot /bin/sh -c "rpm-ostree install $PACKAGES --os=fedora-iot && ostree admin finalize-staged" # && ostree admin deploy ostree/???"
#TODO: check error condition and bail maybe...


chroot /mnt/sysroot /bin/sh -c "rpm-ostree status"
echo HERE ARE YOUR NEW KARGS, TODO: automate the grub thing?
chroot /mnt/sysroot /bin/sh -c "rpm-ostree kargs --os=fedora-iot"

mkdir /mnt/sysroot/var/start

#Install optional k3s-agent:
wget -O /mnt/sysroot/usr/local/bin/k3s https://github.com/rancher/k3s/releases/download/v1.17.5%2Bk3s1/k3s
chmod +x /mnt/sysroot/usr/local/bin/k3s

%end
#
#  ---  END PERCENT POST SECTION -----
#

# Keyboard layouts
keyboard --xlayouts='us'
# System language
#lang en_CA.UTF-8
#lang en_US.UTF-8
lang C.UTF-8

#Additional firewall configuration by systemd unit...
firewall --use-system-defaults

# Network information
network  --hostname=BitMediaCentre

# Run the Setup Agent on first boot
#XXX
#firstboot --enable

#MINE:
ignoredisk --only-use=sdb
bootloader --location=mbr 
zerombr
clearpart --all --initlabel
part /boot --size=512 --asprimary --ondrive=sdb --fstype=xfs
#part swap --size=10240 --ondrive=sda 
part / --size=8192 --grow --asprimary --ondrive=sdb --fstype=xfs 

# System timezone
timezone America/Vancouver --utc

#non-root user:
user --name=pcuser --password=pcuser --plaintext --groups=wheel
rootpw --lock

# Root password
#rootpw --iscrypted $6$tBCS7ZkEfY/I2Rr1$6NDunHAszqFFwcRRXwx75SI7PqrqkFpXw45PWo/ddrsbNaYZJrTvw8HZb10ExisamA48rn2Mv38qcB6bCNjpk/

%addon com_redhat_kdump --disable --reserve-mb='128'

%end

%anaconda
pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty
pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok
pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty
%end
